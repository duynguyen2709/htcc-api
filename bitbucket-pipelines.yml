image: maven:3-jdk-8

pipelines:
  default:
    - parallel:
      - step:
         caches:
           - maven
         script: 
           - cd htcc-gateway-service/
           - mvn -B package
         artifacts: 
          - target/**
      - step:
         caches:
           - maven
         script: 
           - cd htcc-employee-service/
           - mvn -B package
         artifacts: 
           - target/*
    - parallel:
      - step:
         script: 
           - mkdir -p ~/.ssh
           - cd ssh/
           - cat my_known_hosts >> ~/.ssh/known_hosts
           - (umask  077 ; echo $KEY_DEV_1 | base64 --decode > ~/.ssh/id_rsa)
           - ssh root@167.179.80.90 'echo "connected to 167.179.80.90 as $USER"'
      - step:
         script: 
           - mkdir -p ~/.ssh
           - cd ssh/
           - cat my_known_hosts >> ~/.ssh/known_hosts
           - (umask  077 ; echo $KEY_DEV_1 | base64 --decode > ~/.ssh/id_rsa)
           - ssh root@108.61.162.225 'echo "connected to 108.61.162.225 as $USER"'
  custom:
    deploy-gateway-to-dev-1:
      - step:
         script:
          - cd htcc-gateway-service/
          - mvn -B packgage
          - docker build -t duyna5/htcc-gateway-service .
          - docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PASSWORD
          - docker push duyna5/htcc-gateway-service:latest
          - mkdir -p ~/.ssh
          - cd ../ssh/
          - cat my_known_hosts >> ~/.ssh/known_hosts
          - (umask  077 ; echo $KEY_DEV_1 | base64 --decode > ~/.ssh/id_rsa)
          - ssh root@167.179.80.90 'echo "connected to 167.179.80.90 as $USER"'
            
options:
  docker: true